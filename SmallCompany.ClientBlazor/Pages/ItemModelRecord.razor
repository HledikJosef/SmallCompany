@page "/itemModelRecord"
@using SmallCompany.ServiceLayer;
@using ServiceLayer.ModelsBlazor;
@using System.Data;
@using System.Threading;
@inject IPropertiesService propertiesService;
@inject IItemModelCreator itemModelCreator;

<PageTitle>Item-record</PageTitle>

<h1>Vytvoř nový model prvku</h1>
<h5>Vyplň obecný název skupiny, vyber typ prvku(např.materíál, výrobek, zoží..) a zaškrtnutím přiřaď k prvku vhodné vlastnosti a jednotku.</h5>

<form class="form-control">
    <table class="table">
        <tbody>
            <tr>
                <td>
                    <input type="text" class="form-control" placeholder="Název skupiny prvků" @bind-value="@itemGroupName" required>
                </td>
                
            </tr>
            <tr>
                <td>
                    <select class="form-select" @bind="itemTyp" required>
                        <option disabled selected value="">Vyberte typ skupiny</option>
                        @foreach(var itemTyp in blazorItemTyps)
                        {
                            <option value="@itemTyp.ItemTyp">@itemTyp.ItemTyp</option>
                        }
                    </select>
                </td>
                
            </tr>

            @foreach (var property in blazorProperties)
            {                
                <tr>
                    <td>                        
                        <input class="form-check-input" type="checkbox" id="flexCheckDefault" @bind-value=property.IsValid>
                        <label class="form-check-label" for="flexCheckDefault">@property.PropertyName</label>                         
                    </td>
                </tr>
            }
            <tr>
                <td>
                    <select class="form-select" @bind="itemUnit" required>
                        <option disabled selected value="">Vyberte jednotku skupiny</option>
                        @foreach (var unit in blazorUnits)
                        {
                            <option value="@unit.Unit">@unit.Unit</option>
                        }
                    </select>
                </td>

            </tr>
        </tbody>     
    </table>

    <button class="btn btn-primary" @onclick="AddItemRecord">Ulož záznam</button>

</form>



@if (notification != null)
{
    if (notification == "Záznam byl uložen")
    {
        <div id="myAlertSuccess" class="alert alert-success alert-dismissible fade show" role="alert">
            @notification
            <button type="button" class="btn-close" aria-label="Close"></button>
        </div>

        <script>
            // Počkejte 5 sekund a poté skryjte alert
            setTimeout(function () {
                var alert = document.getElementById('myAlertSuccess');
                alert.classList.remove('show');
                alert.classList.add('hide');
            }, 4000); // 5000 ms = 5 sekund
        </script>
    }
    else if (notification == "Záznam se nepodařilo uložit")
    {
        <div id="myAlertDanger" class="alert alert-danger alert-dismissible fade show" role="alert">
            @notification
            <button type="button" class="btn-success" aria-label="Close"></button>
        </div>
    }

}



@code {
    private string? notification = null;
    private string? itemGroupName = null;
    private string? itemUnit = null;
    private string? itemTyp = null;

    List<PropertiesBlazorModel> blazorProperties = new List<PropertiesBlazorModel>();
    List<UnitBlazorModel> blazorUnits = new List<UnitBlazorModel>();
    List<ItemTypBlazorModel> blazorItemTyps = new List<ItemTypBlazorModel>();


    protected override void OnInitialized()
    {
        blazorProperties = propertiesService.GetBlazorProperties();
        blazorUnits = propertiesService.GetBlazorUnits();
        blazorItemTyps = propertiesService.GetBlazorItemTyps();
    }

    private void AddItemRecord()
    {
        bool isSuccessful = false;
        if ((itemTyp != null) && (itemGroupName != null) && (itemUnit != null))
        {
            isSuccessful = itemModelCreator.CreateItemModel(itemGroupName, itemTyp, blazorProperties, itemUnit);        
        }
        SetNotification(isSuccessful);

    }


    private void SetNotification(bool isSuccesfull)
    {
        if (isSuccesfull)
        {
            notification = "Záznam byl uložen";
        }
        else
        {
            notification = "Záznam se nepodařilo uložit";
        }
    }
}
